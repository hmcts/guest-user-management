name: guest-user-management

schedules:
  - cron: "0 2 * * *"
    displayName: Daily build @ 2am
    always: true
    branches:
      include:
        - master

trigger:
  branches:
    include:
      - master

variables:
  - name: timeoutInMinutes
    value: 60
  - name: agentPool
    value: ubuntu-20.04
  - name: service_connection
    value: GA

stages:
  - stage: DeleteInactiveGuestUsers
    pool:
      vmImage: ${{ variables.agentPool }}
    jobs:
      - job: DeleteGuestUsers
        timeoutInMinutes: ${{ variables.timeoutInMinutes }}
        steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: DeleteUnacceptedInvites
            inputs:
              azureSubscription: ${{ variables.service_connection }}
              scriptType: bash
              scriptLocation: scriptPath
              scriptPath: "$(System.DefaultWorkingDirectory)/pipeline-scripts/delete-old-guest-invites.sh"
              arguments: $(Build.SourceBranchName)
          - task: AzureCLI@2
            displayName: DeleteInactiveGuestUsers
            inputs:
              azureSubscription: ${{ variables.service_connection }}
              scriptType: bash
              scriptLocation: scriptPath
              scriptPath: "$(System.DefaultWorkingDirectory)/pipeline-scripts/delete-inactive-guest-users.sh"
              arguments: $(Build.SourceBranchName)
          - script: |
              cp users-*.json $(Build.StagingDirectory)/
              cp guests.json $(Build.StagingDirectory)/
              cp unaccepted_invites.txt $(Build.StagingDirectory)/
            displayName: Set output variable
          - publish: $(Build.StagingDirectory)
            artifact: guests-and-invites
